name: Release - Publish to Crates.io

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.4.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # Pre-Release Validation
  # ============================================================================
  pre-release-checks:
    name: ğŸ” Pre-Release Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          components: clippy, rustfmt
          override: true

      - name: Validate version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "Detected version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        run: cargo test --all-features

      - name: Build documentation
        run: cargo doc --no-deps --all-features

      - name: Package dry-run
        run: cargo package --allow-dirty

      - name: Send pre-release email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'ğŸš€ AVX-HTTP v${{ env.VERSION }} Pre-Release Checks Completed'
          to: nicolas@avila.inc,dev@avila.inc
          from: Release Bot <release@avila.inc>
          body: |
            Pre-release validation passed for AVX-HTTP v${{ env.VERSION }}!

            âœ… Code formatting: PASSED
            âœ… Clippy lints: PASSED
            âœ… Test suite: PASSED
            âœ… Documentation: PASSED
            âœ… Package build: PASSED

            Ready to publish to crates.io!

            Repository: ${{ github.repository }}
            Tag: ${{ github.ref_name }}
            Commit: ${{ github.sha }}

            View details:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # ============================================================================
  # Publish to Crates.io
  # ============================================================================
  publish-crates-io:
    name: ğŸ“¦ Publish to Crates.io
    runs-on: ubuntu-latest
    needs: pre-release-checks
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Get version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: false

      - name: Send success email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'ğŸ‰ AVX-HTTP v${{ env.VERSION }} Published Successfully to Crates.io!'
          to: nicolas@avila.inc,dev@avila.inc
          from: Release Bot <release@avila.inc>
          html_body: |
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; }
                .success { background: #4caf50; color: white; padding: 20px; border-radius: 5px; text-align: center; }
                .details { background: #f4f4f4; padding: 15px; margin: 20px 0; border-radius: 5px; }
                .links { background: #e3f2fd; padding: 15px; margin: 20px 0; border-radius: 5px; }
                .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; }
              </style>
            </head>
            <body>
              <div class="success">
                <h1>ğŸ‰ AVX-HTTP v${{ env.VERSION }} Published!</h1>
                <p>Successfully published to crates.io</p>
              </div>

              <div class="details">
                <h2>ğŸ“¦ Package Details</h2>
                <ul>
                  <li><strong>Package:</strong> avx-http</li>
                  <li><strong>Version:</strong> ${{ env.VERSION }}</li>
                  <li><strong>Published:</strong> $(date -u)</li>
                  <li><strong>Repository:</strong> ${{ github.repository }}</li>
                  <li><strong>Commit:</strong> ${{ github.sha }}</li>
                </ul>
              </div>

              <div class="links">
                <h2>ğŸ”— Important Links</h2>
                <ul>
                  <li><strong>Crates.io:</strong> <a href="https://crates.io/crates/avx-http">https://crates.io/crates/avx-http</a></li>
                  <li><strong>Docs.rs:</strong> <a href="https://docs.rs/avx-http">https://docs.rs/avx-http</a> (will build in 5-10 minutes)</li>
                  <li><strong>GitHub Release:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}">${{ github.ref_name }}</a></li>
                  <li><strong>GitHub Actions:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Run</a></li>
                </ul>
              </div>

              <div class="details">
                <h2>âœ… Post-Publishing Checklist</h2>
                <ul>
                  <li>âœ… Package published to crates.io</li>
                  <li>â³ Wait 5-10 minutes for docs.rs build</li>
                  <li>â³ Create GitHub Release with CHANGELOG</li>
                  <li>â³ Update README badges</li>
                  <li>â³ Announce on Reddit r/rust</li>
                  <li>â³ Post on Twitter/X</li>
                  <li>â³ Submit to This Week in Rust</li>
                </ul>
              </div>

              <div class="footer">
                <p><strong>Next Steps:</strong></p>
                <ol>
                  <li>Verify package at <a href="https://crates.io/crates/avx-http">crates.io</a></li>
                  <li>Check docs build at <a href="https://docs.rs/avx-http">docs.rs</a></li>
                  <li>Create GitHub Release</li>
                  <li>Announce to community</li>
                </ol>
                <p><em>Automated by AVX-HTTP Release Bot</em></p>
              </div>
            </body>
            </html>

      - name: Send failure email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'âŒ AVX-HTTP v${{ env.VERSION }} Publication FAILED'
          to: nicolas@avila.inc,dev@avila.inc
          from: Release Bot <release@avila.inc>
          body: |
            URGENT: Publication to crates.io FAILED!

            Package: avx-http
            Version: ${{ env.VERSION }}
            Tag: ${{ github.ref_name }}

            Possible reasons:
            - Version already published
            - Invalid token
            - Network issues
            - Package validation failed

            Check logs immediately:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            DO NOT push another tag until issue is resolved!

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  create-github-release:
    name: ğŸ“ Create GitHub Release
    runs-on: ubuntu-latest
    needs: publish-crates-io
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Extract CHANGELOG
        run: |
          # Extract changes for this version from CHANGELOG.md
          awk '/^## \['$VERSION'\]/{flag=1;next}/^## \[/{flag=0}flag' CHANGELOG.md > release-notes.md || echo "New release" > release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: AVX-HTTP v${{ env.VERSION }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send GitHub release email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'ğŸ“ AVX-HTTP v${{ env.VERSION }} GitHub Release Created'
          to: nicolas@avila.inc
          from: Release Bot <release@avila.inc>
          body: |
            GitHub Release created for AVX-HTTP v${{ env.VERSION }}!

            View release:
            ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}

            Release notes attached.
          attachments: release-notes.md

  # ============================================================================
  # Post-Release Notifications
  # ============================================================================
  post-release-tasks:
    name: ğŸ“£ Post-Release Notifications
    runs-on: ubuntu-latest
    needs: [publish-crates-io, create-github-release]
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Send community announcement email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'ğŸ“£ AVX-HTTP v${{ env.VERSION }} - Community Announcement Template'
          to: nicolas@avila.inc
          from: Release Bot <release@avila.inc>
          body: |
            AVX-HTTP v${{ env.VERSION }} has been released!

            Use these templates for community announcements:

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            REDDIT r/rust TEMPLATE:
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            Title: [Announcement] AVX-HTTP v${{ env.VERSION }} - Pure Rust HTTP with ZERO dependencies

            Hey r/rust! ğŸ‘‹

            Excited to announce AVX-HTTP v${{ env.VERSION }}!

            ğŸš« ZERO core dependencies (no tokio, no hyper, no serde)
            âš¡ Custom async runtime (epoll/kqueue/IOCP)
            ğŸ”¥ Full HTTP/2 with HPACK compression
            ğŸ”’ Optional TLS 1.3 support

            Crates.io: https://crates.io/crates/avx-http
            GitHub: ${{ github.server_url }}/${{ github.repository }}

            Would love feedback!

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            TWITTER/X TEMPLATE:
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            ğŸš€ Just released AVX-HTTP v${{ env.VERSION }}!

            âœ¨ Pure Rust HTTP/1.1 + HTTP/2
            ğŸš« ZERO dependencies
            âš¡ Custom async runtime
            ğŸ”’ TLS 1.3 support

            https://crates.io/crates/avx-http

            #rustlang #opensource

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            THIS WEEK IN RUST TEMPLATE:
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            Submit PR to: https://github.com/rust-lang/this-week-in-rust

            # New Crates

            * [avx-http](https://crates.io/crates/avx-http) v${{ env.VERSION }} -
              Pure Rust HTTP/1.1 + HTTP/2 with ZERO core dependencies

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            Links:
            - Crates.io: https://crates.io/crates/avx-http
            - Docs.rs: https://docs.rs/avx-http
            - GitHub: ${{ github.server_url }}/${{ github.repository }}
            - Release: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}

            ğŸ‰ Congratulations on the release!
