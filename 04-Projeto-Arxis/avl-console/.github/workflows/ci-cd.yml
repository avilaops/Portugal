name: CI/CD Pipeline

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]
    schedule:
        - cron: "0 0 * * 0" # Weekly on Sunday

env:
    CARGO_TERM_COLOR: always
    RUST_BACKTRACE: 1

jobs:
    # Code quality checks
    fmt:
        name: Rustfmt
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt
            - name: Check formatting
              run: cargo fmt --all --check
              working-directory: avl-console

    clippy:
        name: Clippy
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  components: clippy
            - uses: Swatinem/rust-cache@v2
            - name: Run clippy
              run: cargo clippy --all-targets --all-features -- -D warnings
              working-directory: avl-console

    # Security audit
    security-audit:
        name: Security Audit
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: rustsec/audit-check@v1
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

    # Test suite
    test:
        name: Test Suite
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
                rust: [stable, beta]
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: ${{ matrix.rust }}
            - uses: Swatinem/rust-cache@v2
            - name: Run tests
              run: cargo test --all-features --verbose
              working-directory: avl-console
            - name: Run doc tests
              run: cargo test --doc --all-features
              working-directory: avl-console

    # Coverage report
    coverage:
        name: Code Coverage
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - uses: Swatinem/rust-cache@v2
            - name: Install cargo-tarpaulin
              run: cargo install cargo-tarpaulin
            - name: Generate coverage
              run: cargo tarpaulin --all-features --workspace --timeout 300 --out xml
              working-directory: avl-console
            - name: Upload to codecov.io
              uses: codecov/codecov-action@v4
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  fail_ci_if_error: false

    # Performance benchmarks
    bench:
        name: Performance Benchmarks
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
            - uses: Swatinem/rust-cache@v2
            - name: Run benchmarks
              run: cargo bench --all-features
              working-directory: avl-console
            - name: Store benchmark results
              uses: benchmark-action/github-action-benchmark@v1
              with:
                  tool: "cargo"
                  output-file-path: avl-console/target/criterion/output.txt
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  auto-push: true

    # Build Docker image
    docker:
        name: Docker Build
        runs-on: ubuntu-latest
        needs: [test, clippy, fmt]
        if: github.event_name == 'push'
        steps:
            - uses: actions/checkout@v4
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}
            - name: Build and push
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: avl-console/Dockerfile
                  push: ${{ github.ref == 'refs/heads/main' }}
                  tags: |
                      avilacloud/avl-console:latest
                      avilacloud/avl-console:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    # Deploy to staging
    deploy-staging:
        name: Deploy to Staging
        runs-on: ubuntu-latest
        needs: [docker]
        if: github.ref == 'refs/heads/main'
        environment:
            name: staging
            url: https://console-staging.avila.cloud
        steps:
            - uses: actions/checkout@v4
            - name: Deploy to staging
              run: |
                  echo "Deploying to staging environment..."
                  # Add your deployment commands here
                  # e.g., kubectl, helm, docker-compose, etc.

    # Deploy to production
    deploy-production:
        name: Deploy to Production
        runs-on: ubuntu-latest
        needs: [deploy-staging]
        if: github.ref == 'refs/heads/main'
        environment:
            name: production
            url: https://console.avila.cloud
        steps:
            - uses: actions/checkout@v4
            - name: Deploy to production
              run: |
                  echo "Deploying to production environment..."
                  # Add your production deployment commands here

    # Notify on completion
    notify:
        name: Notify Deployment
        runs-on: ubuntu-latest
        needs: [deploy-production]
        if: always()
        steps:
            - name: Send notification
              uses: 8398a7/action-slack@v3
              with:
                  status: ${{ job.status }}
                  text: "AVL Console deployment completed"
                  webhook_url: ${{ secrets.SLACK_WEBHOOK }}
              if: always()
