version: "3.8"

services:
  # AVL Console - Developer Portal with AI Assistant
  avl-console:
    build:
      context: ..
      dockerfile: avl-console/Dockerfile
    container_name: avl-console
    restart: unless-stopped
    ports:
      - "3000:3000" # HTTP
      - "9090:9090" # Metrics
    environment:
      # Server Configuration
      - AVL_CONSOLE_PORT=3000
      - AVL_CONSOLE_HOST=0.0.0.0
      - AVL_METRICS_PORT=9090
      - RUST_LOG=info,avl_console=debug

      # AvilaDB Configuration
      - AVILADB_ENDPOINT=${AVILADB_ENDPOINT:-http://aviladb:8000}
      - AVILADB_DATABASE=${AVILADB_DATABASE:-console_db}
      - AVILADB_COLLECTION=${AVILADB_COLLECTION:-vectors}
      - AVILADB_API_KEY=${AVILADB_API_KEY}

      # AVL Auth Configuration
      - AVL_AUTH_ENDPOINT=${AVL_AUTH_ENDPOINT:-http://avl-auth:8080}
      - AVL_AUTH_CLIENT_ID=${AVL_AUTH_CLIENT_ID}
      - AVL_AUTH_CLIENT_SECRET=${AVL_AUTH_CLIENT_SECRET}
      - AVL_AUTH_ENABLED=${AVL_AUTH_ENABLED:-true}

      # AVL Telemetry Configuration
      - AVL_TELEMETRY_ENDPOINT=${AVL_TELEMETRY_ENDPOINT:-http://avx-telemetry:4317}
      - AVL_TELEMETRY_ENABLED=${AVL_TELEMETRY_ENABLED:-true}
      - AVL_SERVICE_NAME=avl-console
      - AVL_SERVICE_VERSION=0.3.0

      # AI Backend Configuration
      - AI_BACKEND=${AI_BACKEND:-pattern}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # Feature Flags
      - ENABLE_AI_ASSISTANT=true
      - ENABLE_VECTOR_SEARCH=true
      - ENABLE_QUERY_SAFETY=true
      - ENABLE_RATE_LIMITING=true

      # Security
      - SESSION_SECRET=${SESSION_SECRET:-change-me-in-production}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}

    volumes:
      - console-data:/app/data
      - console-logs:/app/logs
    networks:
      - avl-platform
    depends_on:
      - aviladb
      - avl-auth
      - avx-telemetry
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.avila.service=avl-console"
      - "com.avila.version=0.3.0"
      - "com.avila.tier=frontend"

  # AvilaDB - Distributed NoSQL Database
  aviladb:
    image: avilacloud/aviladb:latest
    container_name: aviladb
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - AVILADB_PORT=8000
      - AVILADB_DATA_PATH=/data
      - RUST_LOG=info
    volumes:
      - aviladb-data:/data
    networks:
      - avl-platform
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # AVL Auth - Identity and Access Management
  avl-auth:
    image: avilacloud/avl-auth:latest
    container_name: avl-auth
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - AVL_AUTH_PORT=8080
      - AVL_AUTH_DATABASE_URL=aviladb://aviladb:8000/auth_db
      - AVL_AUTH_JWT_SECRET=${AVL_AUTH_JWT_SECRET:-change-me-in-production}
      - AVL_AUTH_SESSION_TTL=3600
      - RUST_LOG=info
    volumes:
      - auth-data:/data
    networks:
      - avl-platform
    depends_on:
      - aviladb
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # AVX Telemetry - Observability and Monitoring
  avx-telemetry:
    image: avilacloud/avx-telemetry:latest
    container_name: avx-telemetry
    restart: unless-stopped
    ports:
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
      - "8888:8888" # Metrics
    environment:
      - AVX_TELEMETRY_BACKEND=aviladb://aviladb:8000/telemetry_db
      - RUST_LOG=info
    volumes:
      - telemetry-data:/data
    networks:
      - avl-platform
    depends_on:
      - aviladb
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Redis - Cache e Session Store (opcional)
  redis:
    image: redis:7-alpine
    container_name: avl-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - avl-platform
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 3s
      retries: 3

  # Prometheus - Metrics Collection (opcional)
  prometheus:
    image: prom/prometheus:latest
    container_name: avl-prometheus
    restart: unless-stopped
    ports:
      - "9091:9090"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - avl-platform
    depends_on:
      - avl-console

  # Grafana - Metrics Visualization (opcional)
  grafana:
    image: grafana/grafana:latest
    container_name: avl-grafana
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana-dashboards:/etc/grafana/provisioning/dashboards:ro
    networks:
      - avl-platform
    depends_on:
      - prometheus

networks:
  avl-platform:
    driver: bridge
    name: avl-platform

volumes:
  console-data:
    name: avl-console-data
  console-logs:
    name: avl-console-logs
  aviladb-data:
    name: aviladb-data
  auth-data:
    name: avl-auth-data
  telemetry-data:
    name: avx-telemetry-data
  redis-data:
    name: avl-redis-data
  prometheus-data:
    name: prometheus-data
  grafana-data:
    name: grafana-data
